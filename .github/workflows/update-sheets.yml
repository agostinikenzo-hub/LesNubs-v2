name: Update OP.GG Data to Google Sheets (Debug Mode)

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Node setup ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node dependencies
        run: npm install

      # --- üß© DEBUG: Print OP.GG data for one player ---
      - name: Debug OP.GG API output for one player
        run: |
          echo "Fetching sample data for Amazing Cholo..."
          cat <<'EOF' > debug-opgg.js
          import axios from "axios";

          const region = "euw";
          const summoner = "Amazing Cholo";

          async function run() {
            const infoUrl = "https://www.op.gg/api/v1.0/summoners/" + region + "/" + encodeURIComponent(summoner);
            try {
              const infoRes = await axios.get(infoUrl);
              console.log("=== Summoner Info ===");
              console.log(JSON.stringify(infoRes.data, null, 2));

              const summonerId = infoRes.data?.data?.summoner_id || infoRes.data?.id;
              if (!summonerId) {
                console.error("‚ö†Ô∏è Could not find summoner ID for " + summoner);
                return;
              }

              const matchesUrl = "https://www.op.gg/api/v1.0/games/" + region + "/summoners/" + summonerId + "?limit=2";
              const matchesRes = await axios.get(matchesUrl);
              console.log("=== Last 2 Games ===");
              console.log(JSON.stringify(matchesRes.data, null, 2));
            } catch (e) {
              console.error("‚ùå Error fetching data:", e.message);
            }
          }

          run();
          EOF

          node debug-opgg.js

      # --- Python setup ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: pip install gspread google-auth

      # --- üîÅ Run the full OP.GG ‚Üí Sheets sync ---
      - name: Run OP.GG ‚Üí Sheets sync
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
        run: python riot_to_sheets.py
