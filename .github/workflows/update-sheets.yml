name: Update OP.GG Data to Google Sheets (v2 Debug)

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Node setup ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node dependencies
        run: npm install

      # --- üß© DEBUG: Print OP.GG data for one player using v2 API ---
      - name: Debug OP.GG API output for one player
        run: |
          echo "Fetching sample data for Amazing Cholo (v2 API)..."
          cat <<'EOF' > debug-opgg.js
          import axios from "axios";

          const region = "euw";
          const summoner = "Amazing Cholo";

          async function run() {
            try {
              // ‚úÖ New OP.GG v2 API - get summoner info
              const infoUrl = "https://www.op.gg/api/v2/summoners/" + region + "?summonerName=" + encodeURIComponent(summoner);
              const infoRes = await axios.get(infoUrl);
              console.log("=== Summoner Info ===");
              console.log(JSON.stringify(infoRes.data, null, 2));

              // Extract summoner ID
              const summonerId = infoRes.data?.data?.id || infoRes.data?.id;
              if (!summonerId) {
                console.error("‚ö†Ô∏è Could not find summoner ID for " + summoner);
                return;
              }

              // ‚úÖ Fetch last 2 games using v2 API
              const matchesUrl = "https://www.op.gg/api/v2/summoners/" + summonerId + "/games?limit=2&hl=en_US";
              const matchesRes = await axios.get(matchesUrl);
              console.log("=== Last 2 Games ===");
              console.log(JSON.stringify(matchesRes.data, null, 2));
            } catch (e) {
              console.error("‚ùå Error fetching data:", e.message);
            }
          }

          run();
          EOF

          node debug-opgg.js

      # --- Python setup ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: pip install gspread google-auth

      # --- üîÅ Run the full OP.GG ‚Üí Sheets sync ---
      - name: Run OP.GG ‚Üí Sheets sync
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
        run: python riot_to_sheets.py
